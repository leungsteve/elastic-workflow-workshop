{% extends "base.html" %}

{% block title %}Simulate Attack - Review Fraud Workshop{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-lightning text-danger me-2"></i>Simulate Review Fraud Attack</h1>
        <p class="text-muted">Generate fake negative reviews to trigger detection workflows <span class="badge bg-secondary">v3-bulk</span></p>
    </div>
</div>

<div class="row">
    <!-- Attack Controls -->
    <div class="col-md-5">
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-crosshair me-2"></i>Target Selection
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Select Target Business</label>
                    <select class="form-select" id="targetBusiness">
                        <option value="">Loading businesses...</option>
                    </select>
                </div>
                <div id="targetInfo" class="alert alert-secondary" style="display: none;">
                    <strong id="targetName"></strong>
                    <br>
                    <span id="targetDetails"></span>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-pencil-square me-2"></i>Review Generator
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Star Rating</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="stars" id="star1" value="1" checked>
                        <label class="btn btn-outline-danger" for="star1">1 Star</label>
                        <input type="radio" class="btn-check" name="stars" id="star2" value="2">
                        <label class="btn btn-outline-warning" for="star2">2 Stars</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Review Text</label>
                    <textarea class="form-control" id="reviewText" rows="4" placeholder="Click 'Generate' to create attack review text..."></textarea>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary flex-grow-1" onclick="generateReview()">
                        <i class="bi bi-magic me-1"></i> Generate Text
                    </button>
                    <button class="btn btn-danger flex-grow-1" onclick="submitReview()" id="submitBtn">
                        <i class="bi bi-send me-1"></i> Submit Review
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-lightning-charge me-2"></i>Turbo Attack Mode
            </div>
            <div class="card-body">
                <p class="small text-muted">Submit multiple reviews at once to trigger detection faster</p>
                <div class="mb-3">
                    <label class="form-label">Number of Reviews</label>
                    <input type="range" class="form-range" id="turboCount" min="5" max="25" value="15">
                    <div class="text-center"><span id="turboCountLabel">15</span> reviews</div>
                </div>
                <button class="btn btn-danger w-100" onclick="turboAttack()" id="turboBtn">
                    <i class="bi bi-lightning-fill me-1"></i> Launch Turbo Attack
                </button>
            </div>
        </div>
    </div>

    <!-- Live Feed -->
    <div class="col-md-7">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-activity me-2"></i>Attack Feed</span>
                <span class="badge bg-danger" id="attackCount">0 reviews submitted</span>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                <div id="attackFeed">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-lightning display-4"></i>
                        <p class="mt-3">No attacks yet. Select a target and start submitting reviews!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let attackCount = 0;
    let selectedBusiness = null;

    // Load businesses for dropdown
    async function loadBusinessOptions() {
        try {
            const data = await api.get('/api/businesses?page_size=50');
            const select = document.getElementById('targetBusiness');
            select.innerHTML = '<option value="">-- Select a business --</option>';

            for (const biz of data.businesses) {
                const option = document.createElement('option');
                option.value = biz.business_id;
                option.textContent = `${biz.name} (${biz.city}) - ${biz.stars}★`;
                option.dataset.name = biz.name;
                option.dataset.city = biz.city;
                option.dataset.stars = biz.stars;
                option.dataset.reviews = biz.review_count;
                select.appendChild(option);
            }

            // Check URL for pre-selected target
            const params = new URLSearchParams(window.location.search);
            const target = params.get('target');
            if (target) {
                select.value = target;
                updateTargetInfo();
            }
        } catch (e) {
            console.error('Failed to load businesses:', e);
        }
    }

    function updateTargetInfo() {
        const select = document.getElementById('targetBusiness');
        const option = select.options[select.selectedIndex];
        const info = document.getElementById('targetInfo');

        if (select.value) {
            selectedBusiness = {
                id: select.value,
                name: option.dataset.name,
                city: option.dataset.city,
                stars: option.dataset.stars,
                reviews: option.dataset.reviews
            };
            document.getElementById('targetName').textContent = selectedBusiness.name;
            document.getElementById('targetDetails').textContent =
                `${selectedBusiness.city} | ${selectedBusiness.stars}★ | ${selectedBusiness.reviews} reviews`;
            info.style.display = 'block';
        } else {
            selectedBusiness = null;
            info.style.display = 'none';
        }
    }

    async function generateReview() {
        try {
            const response = await api.get('/api/reviews/generate');
            document.getElementById('reviewText').value = response.text;
        } catch (e) {
            // Generate locally if API not available
            const templates = [
                "Terrible experience. Avoid this place at all costs!",
                "Worst restaurant ever. Food was disgusting.",
                "Never coming back. Complete waste of money.",
                "Horrible service and terrible food. 0 stars if I could.",
                "Do not eat here! You will regret it.",
                "This place is a scam. Stay away!",
                "Absolutely awful. Food made me sick.",
                "Rude staff, bad food, dirty restaurant.",
            ];
            document.getElementById('reviewText').value = templates[Math.floor(Math.random() * templates.length)];
        }
    }

    async function submitReview() {
        if (!selectedBusiness) {
            alert('Please select a target business first');
            return;
        }

        const text = document.getElementById('reviewText').value;
        if (!text) {
            alert('Please enter or generate review text');
            return;
        }

        const stars = document.querySelector('input[name="stars"]:checked').value;
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;

        try {
            const response = await api.post('/api/reviews', {
                business_id: selectedBusiness.id,
                text: text,
                stars: parseInt(stars),
                is_simulated: true
            });

            addToFeed(text, stars, response);
            attackCount++;
            document.getElementById('attackCount').textContent = `${attackCount} reviews submitted`;

            // Generate new review text
            generateReview();
        } catch (e) {
            // Simulate success for demo if API fails
            addToFeed(text, stars, { status: 'pending' });
            attackCount++;
            document.getElementById('attackCount').textContent = `${attackCount} reviews submitted`;
            generateReview();
        }

        btn.disabled = false;
    }

    // Local attack text templates for fast turbo attack
    const attackTemplates = [
        "Terrible experience! Would not recommend to anyone.",
        "Worst restaurant I've ever been to. Complete waste of money.",
        "Absolutely horrible service. Never coming back!",
        "Do NOT go here! They don't care about customers at all.",
        "One star is too generous. This place is awful.",
        "Rude staff, terrible quality. Save your money and go elsewhere.",
        "I can't believe this place is still in business. Horrible!",
        "Total disappointment. Nothing like what they advertise.",
        "Waited forever and got terrible service. Avoid at all costs!",
        "This place is a scam. Don't waste your time or money.",
        "Disgusting! I will be reporting them to the health department.",
        "The worst experience of my life. Completely unacceptable.",
        "Zero stars if I could. Management doesn't care about quality.",
        "Overpriced garbage. There are much better options nearby.",
        "Stay away! This place will ruin your day.",
        "Unprofessional and incompetent staff. Very disappointing.",
        "How is this place still open? Terrible in every way.",
        "Not worth a single penny. Complete rip-off!",
        "Awful, just awful. Don't believe the good reviews.",
        "Never again! What a joke! Total disaster!"
    ];

    function getRandomAttackText() {
        return attackTemplates[Math.floor(Math.random() * attackTemplates.length)];
    }

    async function turboAttack() {
        console.log('[TURBO v3] Starting turbo attack...');

        if (!selectedBusiness) {
            alert('Please select a target business first');
            return;
        }

        const count = parseInt(document.getElementById('turboCount').value);
        const btn = document.getElementById('turboBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Submitting...';

        const url = `/api/reviews/bulk-attack?business_id=${selectedBusiness.id}&count=${count}`;
        console.log('[TURBO v3] Calling:', url);

        try {
            // Single server-side bulk request - completes even if you navigate away
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            console.log('[TURBO v3] Response status:', response.status);

            if (response.ok) {
                const result = await response.json();
                console.log('[TURBO v3] Result:', result);
                console.log('[TURBO v3] Reviews returned:', result.reviews?.length);

                // Add bulk attack summary to feed
                const feed = document.getElementById('attackFeed');
                if (feed.querySelector('.text-muted')) {
                    feed.innerHTML = '';
                }

                const summaryItem = document.createElement('div');
                summaryItem.className = 'card bg-danger text-white mb-2';
                summaryItem.innerHTML = `
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-lightning-fill me-2"></i>
                                <strong>TURBO ATTACK</strong>
                                <span class="ms-2">${result.count} reviews submitted</span>
                            </div>
                            <small>${new Date().toLocaleTimeString()}</small>
                        </div>
                    </div>
                `;
                feed.insertBefore(summaryItem, feed.firstChild);

                // Also add first few individual reviews
                const showCount = Math.min(5, result.reviews.length);
                for (let i = 0; i < showCount; i++) {
                    const review = result.reviews[i];
                    addToFeed(review.text || 'Attack review', review.stars, { status: 'pending' });
                }
                console.log('[TURBO v3] Added summary + ', showCount, 'sample reviews to feed');

                attackCount += result.count;
                document.getElementById('attackCount').textContent = `${attackCount} reviews submitted`;

                // Show success message
                btn.innerHTML = `<i class="bi bi-check-circle me-1"></i> ${result.count} reviews sent!`;
                setTimeout(() => {
                    btn.innerHTML = '<i class="bi bi-lightning-fill me-1"></i> Launch Turbo Attack';
                }, 2000);

                alert(`SUCCESS: ${result.count} attack reviews created! Check dashboard.`);
            } else {
                const errText = await response.text();
                console.error('[TURBO v3] Failed:', errText);
                alert('Attack failed: ' + errText);
                btn.innerHTML = '<i class="bi bi-lightning-fill me-1"></i> Launch Turbo Attack';
            }
        } catch (e) {
            console.error('[TURBO v3] Error:', e);
            alert('Attack error: ' + e.message);
            btn.innerHTML = '<i class="bi bi-lightning-fill me-1"></i> Launch Turbo Attack';
        }

        btn.disabled = false;
    }

    function addToFeed(text, stars, response) {
        const feed = document.getElementById('attackFeed');
        if (feed.querySelector('.text-muted')) {
            feed.innerHTML = '';
        }

        const time = new Date().toLocaleTimeString();
        const starDisplay = '★'.repeat(stars) + '☆'.repeat(5 - stars);
        const statusBadge = response.status === 'held'
            ? '<span class="badge bg-warning">HELD</span>'
            : '<span class="badge bg-secondary">Pending</span>';

        const item = document.createElement('div');
        item.className = 'card review-card simulated mb-2';
        item.innerHTML = `
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="star-rating">${starDisplay}</span>
                        ${statusBadge}
                        <p class="mb-0 small mt-1">${text.substring(0, 100)}${text.length > 100 ? '...' : ''}</p>
                    </div>
                    <small class="text-muted">${time}</small>
                </div>
            </div>
        `;
        feed.insertBefore(item, feed.firstChild);
    }

    // Event listeners
    document.getElementById('targetBusiness').addEventListener('change', updateTargetInfo);
    document.getElementById('turboCount').addEventListener('input', (e) => {
        document.getElementById('turboCountLabel').textContent = e.target.value;
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadBusinessOptions();
        generateReview();
    });
</script>
{% endblock %}
