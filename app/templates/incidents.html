{% extends "base.html" %}

{% block title %}Incidents - Review Campaign Detection Workshop{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-exclamation-triangle text-warning me-2"></i>Incidents</h1>
        <p class="text-muted">Negative review campaign incidents detected by the workflow engine</p>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="filterStatus" onchange="loadIncidents()">
                    <option value="">All</option>
                    <option value="detected">Detected</option>
                    <option value="investigating">Investigating</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="mitigated">Mitigated</option>
                    <option value="resolved">Resolved</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Severity</label>
                <select class="form-select" id="filterSeverity" onchange="loadIncidents()">
                    <option value="">All</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" id="searchQuery" placeholder="Business name or incident ID...">
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="loadIncidents()">
                    <i class="bi bi-search me-1"></i> Search
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Incidents List -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Incidents <span id="incidentCount" class="text-muted"></span></span>
        <button class="btn btn-sm btn-outline-primary" onclick="loadIncidents()">
            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
        </button>
    </div>
    <div class="card-body">
        <div id="incidentList">
            <div class="text-center py-5 text-muted">
                <i class="bi bi-shield-check display-4"></i>
                <p class="mt-3">No incidents detected yet</p>
                <p class="small">Incidents will appear here when the detection workflow triggers</p>
                <a href="/attack" class="btn btn-outline-danger mt-2">
                    <i class="bi bi-lightning me-1"></i> Simulate an Attack
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Incident Detail Modal -->
<div class="modal fade" id="incidentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Incident Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="incidentModalBody">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="resolveIncident('confirmed_attack')">
                    <i class="bi bi-check-circle me-1"></i> Confirm Attack
                </button>
                <button type="button" class="btn btn-warning" onclick="resolveIncident('false_positive')">
                    <i class="bi bi-x-circle me-1"></i> False Positive
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentIncidentId = null;

    async function loadIncidents() {
        const container = document.getElementById('incidentList');
        container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

        const status = document.getElementById('filterStatus').value;
        const severity = document.getElementById('filterSeverity').value;
        const query = document.getElementById('searchQuery').value;

        let url = '/api/incidents?page_size=20';
        if (status) url += `&status=${status}`;
        if (severity) url += `&severity=${severity}`;
        if (query) url += `&q=${encodeURIComponent(query)}`;

        try {
            const data = await api.get(url);
            document.getElementById('incidentCount').textContent = `(${data.total} found)`;

            if (!data.incidents || data.incidents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-shield-check display-4"></i>
                        <p class="mt-3">No incidents found</p>
                        <a href="/attack" class="btn btn-outline-danger mt-2">
                            <i class="bi bi-lightning me-1"></i> Simulate an Attack
                        </a>
                    </div>
                `;
                return;
            }

            let html = '<div class="list-group">';
            for (const incident of data.incidents) {
                const severityClass = {
                    critical: 'danger',
                    high: 'warning',
                    medium: 'info'
                }[incident.severity] || 'secondary';

                const statusClass = {
                    detected: 'danger',
                    investigating: 'warning',
                    confirmed: 'danger',
                    mitigated: 'info',
                    resolved: 'success',
                    false_positive: 'secondary'
                }[incident.status] || 'secondary';

                html += `
                    <div class="list-group-item list-group-item-action" onclick="showIncidentDetail('${incident.incident_id}')" style="cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">
                                    <span class="badge bg-${severityClass} me-2">${incident.severity}</span>
                                    ${incident.business_name || 'Unknown Business'}
                                </h6>
                                <p class="mb-1 small text-muted">
                                    ${incident.review_count || 0} suspicious reviews |
                                    Avg Rating: ${(incident.avg_rating || 0).toFixed(1)}â˜… |
                                    Avg Trust: ${((incident.avg_trust_score || 0) * 100).toFixed(0)}%
                                </p>
                                <small class="text-muted">${incident.incident_id}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-${statusClass}">${incident.status}</span>
                                <br>
                                <small class="text-muted">${new Date(incident.detected_at).toLocaleString()}</small>
                            </div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        } catch (e) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-shield-check display-4"></i>
                    <p class="mt-3">No incidents detected yet</p>
                    <p class="small">Start an attack simulation to trigger the detection workflow</p>
                    <a href="/attack" class="btn btn-outline-danger mt-2">
                        <i class="bi bi-lightning me-1"></i> Simulate an Attack
                    </a>
                </div>
            `;
        }
    }

    async function showIncidentDetail(incidentId) {
        currentIncidentId = incidentId;
        const modal = new bootstrap.Modal(document.getElementById('incidentModal'));
        document.getElementById('incidentModalBody').innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
        modal.show();

        try {
            const incident = await api.get(`/api/incidents/${incidentId}`);

            document.getElementById('incidentModalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Business</h6>
                        <p><strong>${incident.business_name || 'Unknown'}</strong></p>

                        <h6>Detection Time</h6>
                        <p>${new Date(incident.detected_at).toLocaleString()}</p>

                        <h6>Severity</h6>
                        <p><span class="badge bg-${incident.severity === 'critical' ? 'danger' : 'warning'}">${incident.severity}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Suspicious Reviews</h6>
                        <p>${incident.review_count || 0}</p>

                        <h6>Average Rating</h6>
                        <p>${(incident.avg_rating || 0).toFixed(1)} stars</p>

                        <h6>Average Trust Score</h6>
                        <p>${((incident.avg_trust_score || 0) * 100).toFixed(0)}%</p>
                    </div>
                </div>
                <hr>
                <h6>Summary</h6>
                <p>${incident.summary || 'No summary available'}</p>
                <hr>
                <p class="text-muted small mb-0">Incident ID: ${incident.incident_id}</p>
            `;
        } catch (e) {
            document.getElementById('incidentModalBody').innerHTML = '<p class="text-danger">Failed to load incident details</p>';
        }
    }

    async function resolveIncident(resolution) {
        if (!currentIncidentId) return;

        try {
            await api.post(`/api/incidents/${currentIncidentId}/resolve`, { resolution });
            bootstrap.Modal.getInstance(document.getElementById('incidentModal')).hide();
            loadIncidents();
        } catch (e) {
            alert('Failed to resolve incident');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadIncidents);

    // Search on Enter
    document.getElementById('searchQuery').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadIncidents();
    });
</script>
{% endblock %}
