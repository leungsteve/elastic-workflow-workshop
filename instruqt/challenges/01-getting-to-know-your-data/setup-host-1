#!/bin/bash
#
# Setup script for Challenge 1 — runs on host-1
#
# Instruqt pre-populates these environment variables:
#   ELASTICSEARCH_URL, ELASTICSEARCH_USER, ELASTICSEARCH_PASSWORD,
#   ELASTICSEARCH_APIKEY, KIBANA_URL
#
# This script:
#   1. Clones the workshop repo
#   2. Creates a .env file (bridging ELASTICSEARCH_APIKEY → ELASTICSEARCH_API_KEY)
#   3. Creates a Python venv and installs dependencies
#   4. Starts the FastAPI app on port 8000
#   5. Waits for the /health endpoint
#

set -e

WORKSHOP_DIR="/workspace/workshop/elastic-workflow-workshop"
REPO_URL="https://github.com/elastic/elastic-workflow-workshop.git"

echo "=============================================="
echo "[host-1] Challenge 1 Setup"
echo "=============================================="

# ==============================================================================
# Validate / default environment variables
# ==============================================================================
echo ""
echo "Checking environment variables..."

ELASTICSEARCH_URL="${ELASTICSEARCH_URL:-http://kubernetes-vm:30920}"
ELASTICSEARCH_USER="${ELASTICSEARCH_USER:-elastic}"
ELASTICSEARCH_PASSWORD="${ELASTICSEARCH_PASSWORD:-}"
ELASTICSEARCH_APIKEY="${ELASTICSEARCH_APIKEY:-}"
KIBANA_URL="${KIBANA_URL:-http://kubernetes-vm:30002}"

echo "  ELASTICSEARCH_URL:      ${ELASTICSEARCH_URL}"
echo "  ELASTICSEARCH_USER:     ${ELASTICSEARCH_USER}"
echo "  ELASTICSEARCH_PASSWORD: ${ELASTICSEARCH_PASSWORD:+(set)}"
echo "  ELASTICSEARCH_APIKEY:   ${ELASTICSEARCH_APIKEY:+(set)}"
echo "  KIBANA_URL:             ${KIBANA_URL}"

if [ -z "${ELASTICSEARCH_PASSWORD}" ] && [ -z "${ELASTICSEARCH_APIKEY}" ]; then
    echo ""
    echo "  WARNING: Neither ELASTICSEARCH_PASSWORD nor ELASTICSEARCH_APIKEY is set."
    echo "  The app may not be able to authenticate to Elasticsearch."
fi

# ==============================================================================
# Step 1: Clone the workshop repository
# ==============================================================================
echo ""
echo "[1/5] Cloning workshop repository..."

if [ -d "${WORKSHOP_DIR}" ]; then
    echo "  Repository already exists at ${WORKSHOP_DIR}, pulling latest..."
    git -C "${WORKSHOP_DIR}" pull --ff-only || true
else
    mkdir -p "$(dirname "${WORKSHOP_DIR}")"
    git clone "${REPO_URL}" "${WORKSHOP_DIR}"
fi
echo "  Repository ready."

# ==============================================================================
# Step 2: Create .env file
# ==============================================================================
echo ""
echo "[2/5] Creating .env file..."

cat > "${WORKSHOP_DIR}/.env" <<EOF
# Auto-generated by Instruqt setup-host-1
ELASTICSEARCH_URL=${ELASTICSEARCH_URL}
ELASTICSEARCH_USERNAME=${ELASTICSEARCH_USER}
ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}
ELASTICSEARCH_API_KEY=${ELASTICSEARCH_APIKEY}
KIBANA_URL=${KIBANA_URL}
ELASTICSEARCH_VERIFY_CERTS=false
EOF

echo "  .env file written to ${WORKSHOP_DIR}/.env"

# ==============================================================================
# Step 3: Create Python venv and install dependencies
# ==============================================================================
echo ""
echo "[3/5] Setting up Python virtual environment..."

cd "${WORKSHOP_DIR}"

python3 -m venv .venv
source .venv/bin/activate

pip install --upgrade pip > /tmp/pip_upgrade.log 2>&1
pip install -r requirements.txt > /tmp/pip_install.log 2>&1
echo "  Dependencies installed."

# ==============================================================================
# Step 4: Start FastAPI application
# ==============================================================================
echo ""
echo "[4/5] Starting FastAPI application on port 8000..."

nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 \
    > /tmp/app.log 2>&1 &

# ==============================================================================
# Step 5: Wait for /health endpoint
# ==============================================================================
echo ""
echo "[5/5] Waiting for application health check..."

MAX_RETRIES=30
RETRY=0

until curl -s http://localhost:8000/health > /dev/null 2>&1; do
    RETRY=$((RETRY + 1))
    if [ $RETRY -ge $MAX_RETRIES ]; then
        echo "  Warning: App did not become ready in time. Check /tmp/app.log"
        break
    fi
    echo "  Waiting... (attempt ${RETRY}/${MAX_RETRIES})"
    sleep 2
done

# ==============================================================================
# Final status
# ==============================================================================
echo ""
echo "=============================================="
echo "[host-1] Challenge 1 Setup Complete!"
echo "=============================================="

if curl -s http://localhost:8000/health > /dev/null 2>&1; then
    echo "  FastAPI app:    RUNNING (http://localhost:8000)"
    echo "  ElasticEats UI: http://localhost:8000/elasticeats"
else
    echo "  FastAPI app:    NOT READY (check /tmp/app.log)"
fi

echo "  Elasticsearch:  ${ELASTICSEARCH_URL}"
echo "  Kibana:         ${KIBANA_URL}"
echo ""
