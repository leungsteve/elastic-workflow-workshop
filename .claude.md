# Claude Code Instructions for Review Fraud Detection Workshop

## QUICK RESUME (Start Here Each Session)

**Last Updated:** 2026-01-21

### Current Status: âœ… FULLY FUNCTIONAL
- All features implemented and tested
- Code committed and pushed to main

### Start the App (if not running)
```bash
curl -s localhost:8080/health | jq . || \
  (nohup python3 -c "import uvicorn; uvicorn.run('app.main:app', host='0.0.0.0', port=8080)" > /tmp/app.log 2>&1 & sleep 5 && curl -s localhost:8080/health)
```

### Run Full E2E Test
```bash
# Attack + Detection + Response
curl -X POST "localhost:8080/api/reviews/bulk-attack?business_id=target_biz_001&count=15"
curl -X POST "localhost:8080/api/incidents/detect?business_id=target_biz_001&hours=1"
```

### What's Working
| Component | Status |
|-----------|--------|
| Web App (port 8080) | âœ… |
| Bulk Attack Endpoint | âœ… |
| Detection Workflow | âœ… |
| Response Actions (protect/hold) | âœ… |
| Agent Builder Tools | âœ… |
| Agent Builder Agent | âœ… |

### Recent Changes (update this after each session)
- 2026-01-21: Added response actions, fixed Agent Builder setup, full E2E verified

---

## Continuous Learning - IMPORTANT

**Update `docs/lessons-learned.md` proactively** when you encounter:

1. **A bug that took multiple attempts to fix** - Document the root cause and solution
2. **Platform-specific gotchas** - e.g., "Serverless doesn't support X"
3. **Non-obvious solutions** - Things that weren't in the docs or required experimentation
4. **Patterns that saved time** - Reusable approaches worth remembering
5. **User confusion points** - If the user had to ask "why isn't this working?" multiple times

**How to update:**
- Add to the appropriate section, or create a new section
- Include: Problem â†’ Root Cause â†’ Solution â†’ Code example if helpful
- Keep it concise and actionable

**When to update:**
- After resolving a tricky bug
- After discovering a better pattern
- At natural breakpoints (before user ends session, after completing a feature)

Don't ask permission - just update the file when you learn something valuable.

---

## Project Overview

This project builds a workshop demonstrating Elastic's Workflows feature (headline for 9.3) using a review fraud detection scenario. The workshop is part of the "What's New in Elastic Search" series and will be delivered via Instruqt. The fraud detection pattern applies to any review platform: Yelp, Amazon, Google, App stores, etc.

**Key Message:** "Search finds the insight. Workflows acts on it. Agent Builder explains it."

**Three Themes:** SIMPLIFY (readable ES|QL queries), OPTIMIZE (automated response), INNOVATE WITH AI (natural language investigation)

**Primary Specification:** See `docs/review-fraud-workshop-spec.md` for complete requirements.

---

## Critical Rules - DO NOT VIOLATE

- **Focus on understanding first** - Prioritize understanding the code and the root cause of issues before jumping to solutions
- **NEVER create mock data or simplified components** unless explicitly told to do so
- **NEVER replace existing complex components with simplified versions** - always fix the actual problem
- **ALWAYS work with the existing codebase** - do not create new simplified alternatives
- **ALWAYS find and fix the root cause** of issues instead of creating workarounds
- When debugging issues, focus on fixing the existing implementation, not replacing it
- When something doesn't work, debug and fix it - don't start over with a simple version
- **NEVER make code changes without explicit instruction** - Always wait for explicit permission before modifying code
- **Spend adequate time diagnosing issues** - Before suggesting or implementing solutions, thoroughly understand the codebase and diagnose root causes
- **Always present options before implementing** - When asked for recommendations, provide options and wait for instruction
- **Ask for approval before major changes** - When making significant code changes, check with user first even if instructed to fix an issue
- Use virtual environments or .env or equivalent whenever appropriate for code isolation or security best practice
- Use Test Driven Development

---

## Project-Specific Guidelines

### Data Handling

- **Yelp Dataset:** The Yelp Academic Dataset must be downloaded separately from https://www.yelp.com/dataset. Do not attempt to generate fake Yelp data as a substitute.
- **Real vs Synthetic Data:**
  - Businesses, users, and historical reviews come from REAL Yelp data
  - Attack reviews and attacker accounts are SYNTHETIC (generated)
  - Never mix these up or substitute one for the other
- **Data Partitioning:** Reviews must be partitioned into `historical`, `streaming`, and `attack` sets. Respect these partitions.
- **Target Business:** A specific business is selected as the attack target. This selection has criteria (4+ stars, 50-200 reviews, Restaurant category). Do not hardcode a business ID without following the selection logic.

### Elasticsearch

- **Always use environment variables** for Elasticsearch connection details:
  - `ELASTICSEARCH_URL`
  - `ELASTICSEARCH_API_KEY`
- **Never hardcode credentials** in any script or configuration file
- **Index mappings are defined in `mappings/`** - always reference these, do not create ad-hoc mappings
- **ES|QL queries** should be stored in `queries/` directory for reuse
- **Test queries in Kibana Dev Tools first** before embedding in code
- **Bulk operations:** Use the Elasticsearch bulk API for loading large datasets, not individual document indexing

### Python Development

- **Virtual environment required:** Create and use a virtual environment for all Python work
- **Dependencies:** Maintain `requirements.txt` with pinned versions
- **Code style:** Follow PEP 8, use type hints where practical
- **Error handling:** All Elasticsearch operations should have proper error handling and retry logic
- **Logging:** Use Python's logging module, not print statements, for operational output
- **Configuration:** Use YAML for configuration files, load with PyYAML

### Streaming Application

- **Three modes must be supported:** `replay`, `inject`, `mixed`
- **Rate limiting:** Respect configured reviews_per_second to avoid overwhelming Elasticsearch
- **Graceful shutdown:** Support Ctrl+C for clean termination
- **Progress output:** Log activity to console so demo viewers can follow along
- **Idempotency:** Running the injector multiple times should not corrupt data (use unique IDs)

### Workflow Definitions

- **YAML format:** Workflows are defined in YAML following the Keep/Elastic Workflows schema
- **Stored in `workflows/`:** Do not embed workflow definitions in other files
- **Parameterized:** Use template variables (e.g., `{{ item.business_id }}`) not hardcoded values
- **Testable steps:** Each workflow step should be independently testable

### Agent Builder Tools

- **JSON format:** Tool definitions are JSON files in `agent-tools/`
- **ES|QL based:** All tools use ES|QL queries, not DSL
- **Parameterized:** Use `{{ parameter_name }}` syntax for inputs
- **Descriptive:** Include clear descriptions for both the tool and each parameter

### Instruqt Challenges

- **Assignment files:** Written in Markdown (`assignment.md`)
- **Setup scripts:** Bash scripts that prepare the environment (`setup.sh`)
- **Check scripts:** Bash scripts that verify completion (`check.sh`)
- **Idempotent setup:** Setup scripts should be safe to run multiple times
- **Clear verification:** Check scripts should give clear pass/fail feedback

---

## File Organization

```
review-fraud-workshop/
â”œâ”€â”€ .claude.md                    # This file
â”œâ”€â”€ .env.example                  # Template for environment variables
â”œâ”€â”€ .gitignore                    # Exclude .env, data/raw/, venv/, etc.
â”œâ”€â”€ README.md                     # Project overview and quick start
â”œâ”€â”€ docs/review-fraud-workshop-spec.md  # Full specification document
â”œâ”€â”€ requirements.txt              # Python dependencies
â”‚
â”œâ”€â”€ admin/                        # Pre-workshop setup (not run by participants)
â”œâ”€â”€ config/                       # Configuration files
â”œâ”€â”€ data/                         # Data files (some gitignored)
â”œâ”€â”€ mappings/                     # Elasticsearch index mappings
â”œâ”€â”€ queries/                      # ES|QL query files
â”œâ”€â”€ workflows/                    # Workflow YAML definitions
â”œâ”€â”€ agent-tools/                  # Agent Builder tool definitions
â”œâ”€â”€ streaming/                    # Streaming application
â”œâ”€â”€ instruqt/                     # Workshop challenges
â”œâ”€â”€ presentation/                 # Slides and talk track
â””â”€â”€ docs/                         # Additional documentation
```

---

## Environment Setup

### Required Environment Variables

```bash
# Elasticsearch connection
ELASTICSEARCH_URL=https://your-cluster.es.cloud.elastic.co:443
ELASTICSEARCH_API_KEY=your-api-key

# Optional: Target business override
TARGET_BUSINESS_ID=yelp-biz-xxxxx
```

### Python Environment

```bash
# Create virtual environment
python -m venv venv
source venv/bin/activate  # Linux/Mac
# or: venv\Scripts\activate  # Windows

# Install dependencies
pip install -r requirements.txt
```

### Verification

Before starting development, verify:

1. Elasticsearch is accessible with provided credentials
2. Required indices can be created
3. ELSER model is deployed (for semantic search)

---

## Testing Strategy

### Unit Tests

- Test data transformation functions independently
- Test trust score calculation with known inputs
- Test review partitioning logic
- Mock Elasticsearch client for unit tests

### Integration Tests

- Use a test index prefix (e.g., `test-businesses`, `test-reviews`)
- Clean up test indices after each test run
- Test full workflow execution against test indices

### End-to-End Tests

- Verify complete data pipeline from raw Yelp data to loaded indices
- Test streaming application in all three modes
- Verify workflow triggers correctly on injected attack

### Test Data

- Create small sample datasets for testing (100 businesses, 500 users, 2000 reviews)
- Store in `data/sample/` for quick iteration
- Do not use sample data as substitute for real Yelp data in production

---

## Common Tasks

### Adding a New ES|QL Query

1. Write and test query in Kibana Dev Tools
2. Save to appropriate file in `queries/`
3. Add any new fields to index mappings if needed
4. Update spec document if this is a new detection pattern

### Adding a New Workflow Step

1. Understand existing workflow structure
2. Add step to appropriate workflow YAML
3. Test step independently before full workflow test
4. Update Instruqt challenge if workflow changes affect workshop

### Modifying Index Mappings

1. Update JSON file in `mappings/`
2. Update `create-indices.py` if new index
3. Update data loading scripts if new fields
4. Update spec document to reflect changes
5. Consider migration path for existing data

### Debugging Streaming Application

1. Check Elasticsearch connection first
2. Verify source data files exist and are valid NDJSON
3. Run in verbose/debug mode
4. Check Elasticsearch index for ingested documents
5. Review application logs for errors

---

## Security Considerations

- **Never commit `.env` files** - use `.env.example` as template
- **API keys should have minimal required permissions**
- **Yelp dataset has usage restrictions** - respect academic/educational use terms
- **Synthetic data should not include real PII** - use Faker or similar for generated names
- **Workshop environments are temporary** - do not store sensitive data

---

## Dependencies

### Python Packages (Core)

```
elasticsearch>=8.0.0
pyyaml>=6.0
python-dotenv>=1.0.0
faker>=18.0.0
tqdm>=4.65.0
```

### Python Packages (Development)

```
pytest>=7.0.0
pytest-cov>=4.0.0
black>=23.0.0
flake8>=6.0.0
mypy>=1.0.0
```

---

## Reference Documentation

- **Elasticsearch Python Client:** https://elasticsearch-py.readthedocs.io/
- **ES|QL Documentation:** https://www.elastic.co/guide/en/elasticsearch/reference/current/esql.html
- **Elastic Workflows (Keep):** https://docs.keephq.dev/
- **Yelp Dataset Documentation:** https://www.yelp.com/dataset/documentation/main
- **Instruqt Track Development:** https://docs.instruqt.com/
- **Lessons Learned:** See `docs/lessons-learned.md` for patterns and gotchas from this project

---

## Troubleshooting

### "Connection refused" to Elasticsearch

1. Verify `ELASTICSEARCH_URL` is correct
2. Check API key has not expired
3. Verify network access (VPN, firewall)

### "Index not found" errors

1. Run `create-indices.py` first
2. Check index name matches exactly (case-sensitive)
3. Verify you're pointing to correct cluster

### Streaming application not ingesting

1. Check source file path is correct
2. Verify NDJSON format (one JSON object per line)
3. Check Elasticsearch bulk response for errors
4. Verify index mapping accepts the document structure

### ELSER not working

1. Verify ELSER model is deployed in ML nodes
2. Check inference endpoint is configured
3. Ensure `semantic_text` field type is used correctly

---

## Contact

For questions about this workshop:

- **Workshop Owner:** Steve (Solutions Architect, Elastic)
- **Specification:** See `docs/review-fraud-workshop-spec.md`

---

## Current Implementation Status (Updated: 2026-01-20)

### COMPLETED - ALL MAJOR COMPONENTS âœ“

#### Infrastructure
- [x] Project structure created per spec
- [x] Configuration files: `.env.example`, `config/config.yaml`, `requirements.txt`
- [x] Elasticsearch connection working (Cloud Serverless)
- [x] Index mappings created (serverless-compatible, no shard settings)
- [x] Sample data generated and loaded (100 businesses, 500 users, 2000 reviews)

#### Indices Created
- `businesses` - Business data with protection fields
- `users` - User data with trust scores
- `reviews` - Reviews with `is_simulated` flag for attack detection
- `incidents` - Incident tracking (auto-created by detection system)
- `notifications` - Notification storage

#### FastAPI Web Application (`app/`)
- [x] Main app with lifespan management (`app/main.py`)
- [x] All API routers working:
  - `/api/businesses` - List, get, stats endpoints
  - `/api/reviews` - CRUD + bulk-attack endpoint
  - `/api/incidents` - CRUD + resolve + detect endpoints
  - `/api/notifications` - CRUD + mark-read endpoints
- [x] Templates created:
  - Dashboard (`index.html`) - Auto-refresh every 3s, attack alerts, business under attack sidebar
  - Businesses (`businesses.html`) - Search/filter with pagination
  - Attack (`attack.html`) - Target selection, turbo attack (server-side bulk)
  - Incidents (`incidents.html`) - List with filters, resolve modal
  - Notifications (`notifications.html`) - List with mark-read

#### Attack Simulation & Detection
- [x] Single review submission works
- [x] **Turbo attack uses server-side bulk endpoint** (`POST /api/reviews/bulk-attack`)
- [x] Attack detection logic in `/api/businesses/{id}/stats`
- [x] **Auto-incident creation** - `app/services/incident_service.py`
  - Automatically creates incidents when attacks detected
  - Duplicate prevention (no duplicate incidents for ongoing attacks)
  - Severity classification: CRITICAL, HIGH, MEDIUM, LOW
- [x] Manual detection endpoint: `POST /api/incidents/detect`

#### Streaming Application (`streaming/`)
- [x] `review_streamer.py` - Full implementation with three modes:
  - `replay` - Stream legitimate reviews from NDJSON files
  - `inject` - Inject attack reviews targeting a business
  - `mixed` - Normal traffic then automatic attack injection
- [x] Rate limiting, bulk API, graceful shutdown, progress logging
- [x] Tested and verified working

#### Admin Scripts (`admin/`)
- [x] `generate_sample_data.py` - Creates sample businesses, users, reviews
- [x] `create_indices.py` - Creates ES indices from mappings
- [x] `load_data.py` - Bulk loads data to ES
- [x] `filter_businesses.py` - Filter Yelp data by city/category
- [x] `filter_users.py` - Extract users who reviewed filtered businesses
- [x] `calculate_trust_scores.py` - Calculate trust scores for users
- [x] `partition_reviews.py` - Split into historical (80%) and streaming (20%)
- [x] `generate_attackers.py` - Create synthetic attacker accounts and reviews
- [x] `prepare_data.sh` - Master setup script with full pipeline
- [x] `README.md` - Complete documentation

#### Agent Builder Tools (`agent-tools/`)
- [x] `incident-summary.json` - Summarize incident with metrics
- [x] `reviewer-pattern-analysis.json` - Detect fake account patterns
- [x] `business-health-check.json` - Assess review health with risk scoring
- [x] `attack-timeline.json` - Chronological attack event view
- [x] `README.md` - Deployment docs and example prompts

#### Instruqt Challenges (`instruqt/challenges/`)
- [x] `01-getting-to-know-your-data/` - ES|QL basics, LOOKUP JOIN (15 min)
- [x] `02-workflows/` - Detection workflow building (20 min)
- [x] `03-agent-builder/` - AI investigation tools (10 min)
- [x] `04-end-to-end-scenario/` - Full attack lifecycle (15 min)
- Each challenge has: `assignment.md`, `setup.sh`, `check.sh`, `solve.sh`

#### Presentation (`presentation/`)
- [x] `slides.md` - 660-line Markdown slide deck (reveal.js compatible)
- [x] `talk-track.md` - 640-line speaker guide with demo script, timing, Q&A

#### Workflow Definitions (`workflows/`)
- [x] `review_fraud_detection.yaml` - Detection and response workflow
- [x] `api_incident_workflow.yaml` - API-based incident creation docs
- [x] Additional workflow YAML files for reviewer flagging, incident resolution

### KNOWN ISSUES (Minor)

~~1. **Attack page feed not updating**~~ - FIXED: Added JavaScript polling (3-second interval) with LIVE indicator. Feed auto-updates when new attack reviews are submitted.

~~2. **Business stars/review_count are static**~~ - FIXED: Added `app/services/business_stats.py` that recalculates stats as a background task after review create/delete operations.

### END-TO-END FLOW VERIFIED âœ“

Tested complete flow:
1. Streaming app injects 15 attack reviews
2. Stats endpoint detects attack (`is_under_attack: true`)
3. Incident auto-created with severity "high"
4. All systems working together

### HOW TO RUN

```bash
# Terminal 1: Start the web app
cd /workspace/elastic-workflow-workshop
python3 -m app.main

# Access at http://localhost:8000

# Terminal 2: Run streaming app (optional)
python3 streaming/review_streamer.py --mode inject --business-id <ID> --count 15

# Or mixed mode for demo
python3 streaming/review_streamer.py --mode mixed --business-id <ID> --normal-duration 60
```

### REMAINING ITEMS (Lower Priority)

- [x] **ELSER integration** - COMPLETED (see session 2026-01-21 below)
- [ ] **Integration tests** - pytest tests for admin scripts and API endpoints
- [ ] **Docker containerization** - Dockerfile exists but not fully tested
- [ ] **Real Yelp data at scale** - Scripts work, tested with sample subset

---

## SESSION COMPLETED (2026-01-21) - Agent Builder Setup Script

### What Was Done This Session

1. **Created `admin/setup_agent_builder.py`** âœ…
   - Python script that creates all Agent Builder resources via API
   - Creates 3 tools: `incident_summary`, `reviewer_analysis`, `similar_reviews`
   - Creates 1 agent: `review_fraud_investigator` with all tools assigned
   - Supports `--delete` flag to clean up existing resources
   - Supports `--dry-run` to preview changes
   - Auto-derives KIBANA_URL from ELASTICSEARCH_URL if not set

2. **Updated Challenge 3 with Quick Setup Alternative** âœ…
   - Added callout at top of Tasks section
   - Participants can run `python admin/setup_agent_builder.py`
   - Then skip directly to Task 6 to test the agent

3. **Updated Bonus Section** âœ…
   - Added instructions to assign bonus tools to the agent
   - Tools must be associated with an agent to be usable

### Two Paths for Participants
| Path | Approach | Time |
|------|----------|------|
| **Manual** | Tasks 1-5 (UI walkthrough) | 15 min |
| **Script** | Run script â†’ Task 6 | 3 min |

### Script Usage
```bash
python admin/setup_agent_builder.py           # Create all
python admin/setup_agent_builder.py --delete  # Delete and recreate
python admin/setup_agent_builder.py --dry-run # Preview only
```

---

## SESSION COMPLETED (2026-01-21) - Challenge 3 Simplification & Agent Creation

### What Was Done This Session

1. **Removed Dev Tools Alternatives from Challenge 3** âœ…
   - Removed all "Alternative: Create via Dev Tools" sections
   - Removed "Option B: Using Dev Tools" from Task 1
   - Cleaner workshop flow focused on UI experience

2. **Added Agent Creation Task (Task 5)** âœ…
   - New task: Create the Review Fraud Investigator Agent
   - Agent configuration:
     - Agent ID: `review_fraud_investigator`
     - Display Name: `Review Fraud Investigator`
     - Custom instructions for Trust & Safety investigation workflow
   - Tool assignment: `incident_summary`, `reviewer_analysis`, `similar_reviews`
   - Optional: avatar color and symbol customization

3. **Updated Task Structure** âœ…
   - Task 1: Navigate to Agent Builder (1 min)
   - Task 2: Create Incident Summary Tool (3 min)
   - Task 3: Create Reviewer Analysis Tool (3 min)
   - Task 4: Create Similar Reviews Tool (3 min)
   - Task 5: Create Review Fraud Investigator Agent (3 min) - NEW
   - Task 6: Test Your Agent (2 min) - renamed from Task 5
   - Total time: 15 minutes (was 10)

4. **Updated Challenge 4 References** âœ…
   - Changed "AI Assistant panel" â†’ "Review Fraud Investigator agent"
   - Updated background to mention custom agent
   - Task 4 now references the specific agent created in Challenge 3

5. **Cleaned Up Bonus Section** âœ…
   - Removed Dev Tools API commands from bonus tools
   - Kept only ES|QL queries and tool configuration details

### Key Concept: Tools vs Agents
- **Tools** = ES|QL queries with parameters (the capabilities)
- **Agents** = AI models with custom instructions + assigned tools (the personality)

Workshop now teaches both creating tools AND creating a custom agent to use them.

---

## SESSION COMPLETED (2026-01-21) - Challenge 3 ES|QL Fixes

### What Was Done This Session

1. **Fixed Incident Summary Tool (Task 2)** âœ…
   - Replaced invalid `stars AS business_original_rating` with EVAL pattern
   - Fixed field names to match actual incidents index mapping:
     - `metrics.review_count` â†’ `review_count`
     - `metrics.avg_stars` â†’ `avg_rating`
     - `metrics.avg_trust` â†’ `avg_trust_score`
     - `metrics.unique_attackers` â†’ `unique_reviewers`

2. **Fixed Similar Reviews Tool (Task 4)** âœ…
   - Changed `MATCH` to `:` operator for semantic search
   - Added `METADATA _score` for relevance scoring
   - Added `SORT _score DESC` for ranking
   - Added `_score` to KEEP clause

3. **Fixed Reviewer Analysis Tool (Task 3)** âœ…
   - Changed `@timestamp` to `date` (matches reviews mapping)
   - Updated both displayed query and Dev Tools API command

4. **Updated lessons-learned.md** âœ…
   - Added documentation about KEEP clause not supporting AS aliases

### Key Lesson
ES|QL KEEP clause does not support aliases (`AS`). Use EVAL to rename columns before KEEP:
```esql
// WRONG
| KEEP stars AS business_original_rating

// CORRECT
| EVAL business_original_rating = stars
| KEEP business_original_rating
```

---

## SESSION COMPLETED (2026-01-21) - ELSER Integration

### What Was Done This Session

1. **ELSER Semantic Search Integration** âœ…
   - Added `text_semantic` field (type: `semantic_text`) to reviews mapping
   - Uses `.elser-2-elastic` inference endpoint (available on Cloud 9.3.0)
   - Verified semantic search working with ES|QL `:` operator

2. **ES|QL Semantic Search Syntax** âœ…
   - Discovered correct syntax: `text_semantic: "search query"` (colon operator)
   - Must use `METADATA _score` and `SORT _score DESC` for relevance ranking
   - Works directly in Discover - no need to go to Dev Tools

3. **Updated Workshop Content for Semantic Search** âœ…
   - `mappings/reviews.json` - Added `text_semantic` field with `copy_to`
   - `mappings/users.json` - Fixed date format for `yelping_since` field
   - `admin/create_indices.py` - Added ELSER availability check, `--skip-semantic` flag
   - `queries/semantic/` - Created 3 ES|QL semantic search queries
   - `agent-tools/similar-reviews.json` - Semantic search tool for Agent Builder
   - `presentation/talk-track.md` - Added semantic search narrative

4. **Updated Instruqt Challenges** âœ…
   - Challenge 01: Added Task 4 for semantic search exploration (ES|QL in Discover)
   - Challenge 03: Added similar-reviews tool creation
   - Challenge 04: Added semantic search for attack narrative analysis
   - **All challenges now use Discover + ES|QL** (avoid Dev Tools for ES|QL queries)

5. **Fixed Navigation Instructions** âœ…
   - Challenge 01: Changed from "Dev Tools" to "Discover > ES|QL mode"
   - Challenge 04: Changed from "Dev Tools" to "Discover > ES|QL mode"
   - Dev Tools only used where required (Kibana API calls in Challenge 02)

### Key Message Updated
> "Search finds the insight - ES|QL detects the anomaly, semantic search reveals the narrative. Workflows acts on it. Agent Builder explains it."

### Story Arc
| Phase | Capability | What It Shows |
|-------|------------|---------------|
| **Detect** | ES|QL + LOOKUP JOIN | Analytical search finds anomaly (velocity, trust) |
| **Understand** | Semantic Search | Content analysis reveals attack narrative |
| **Automate** | Workflows | Native automation responds |
| **Investigate** | Agent Builder | Natural language queries |

### Semantic Search Test Results
```
Query: "food poisoning made me ill"
Top Result: Score 16.72 - "Food poisoned. Friday 4/27 lunchtime..."
```
Semantic search correctly finds reviews about illness even when using different words.

---

## PREVIOUS SESSION (2026-01-21) - End-to-End Testing

### What Was Done This Session

1. **End-to-End Workshop Testing** âœ…
   - Tested all 4 challenges against live Elastic Cloud 9.3.0 cluster
   - Fixed LOOKUP JOIN (requires `index.mode: lookup` in mappings)
   - Fixed Agent Builder API schema (`configuration.params` not `esql.parameters`)
   - Verified detection queries work with attack simulation

2. **Streaming App Fixed** âœ…
   - Now creates attacker user records when injecting attack reviews
   - LOOKUP JOIN detection queries work correctly
   - Shows "Attacker users: N" in session summary

3. **Instruqt Setup Scripts Created** âœ…
   - `admin/prebake_data.sh` - Run during image build (generates 300 businesses, 1500 users, 8000 reviews)
   - `admin/setup_workshop_data.sh` - Run at workshop start (loads data in ~15 seconds)
   - Updated `admin/README.md` with Instruqt integration docs

4. **Documentation Updated** âœ…
   - `docs/lessons-learned.md` - Added LOOKUP JOIN, Agent Builder API findings
   - Challenge 02 and 03 assignment files - Fixed API schemas
   - `mappings/users.json` and `mappings/businesses.json` - Added lookup mode

### Data Configuration for Workshop

| Index | Documents | Size |
|-------|-----------|------|
| businesses | 300 | ~189 KB |
| users | 1,510 | ~843 KB |
| reviews | 8,000 | ~3.9 MB |
| **Total** | **~10,000** | **~5 MB** |

### How to Set Up for Instruqt

**Image Build Time:**
```bash
./admin/prebake_data.sh
```

**Workshop Start (setup script):**
```bash
./admin/setup_workshop_data.sh
```

---

## PREVIOUS SESSION NOTES (2026-01-21)

### Completed: Kibana API Exploration

**Goal:** Programmatically test workflows and agent builder tools via Kibana API

**Status:** âœ… COMPLETED - Found and documented all major API endpoints

---

### DISCOVERED KIBANA API ENDPOINTS

#### Authentication
All endpoints require API key auth via header:
```bash
-H "Authorization: ApiKey <base64-encoded-api-key>"
-H "kbn-xsrf: true"
```

#### Agent Builder Tools API (`/api/agent_builder/tools`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/agent_builder/tools` | List all tools (builtin + custom) |
| GET | `/api/agent_builder/tools/{id}` | Get tool by ID |
| POST | `/api/agent_builder/tools` | Create new tool |
| DELETE | `/api/agent_builder/tools/{id}` | Delete tool |

**Create Tool Request Body:**
```json
{
  "id": "namespace.tool_name",
  "type": "esql",
  "description": "Tool description",
  "tags": ["tag1", "tag2"],
  "configuration": {
    "query": "FROM index | WHERE field == ?param | LIMIT 10",
    "params": {
      "param": {
        "type": "text",
        "description": "Parameter description"
      }
    }
  }
}
```

#### Agent Builder Agents API (`/api/agent_builder/agents`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/agent_builder/agents` | List all agents |
| GET | `/api/agent_builder/agents/{id}` | Get agent by ID |
| POST | `/api/agent_builder/agents` | Create new agent |
| DELETE | `/api/agent_builder/agents/{id}` | Delete agent |

**Create Agent Request Body:**
```json
{
  "id": "custom_agent",
  "name": "My Custom Agent",
  "description": "Agent description",
  "configuration": {
    "instructions": "System prompt for the agent",
    "tools": [{"tool_ids": ["tool1", "tool2"]}]
  }
}
```

#### Agent Conversations API
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/agent_builder/conversations` | List conversations |
| GET | `/api/agent_builder/conversations/{id}` | Get conversation |
| DELETE | `/api/agent_builder/conversations/{id}` | Delete conversation |
| POST | `/api/agent_builder/converse` | Chat with agent |

**Converse Request Body:**
```json
{
  "input": "User message",
  "agent_id": "optional-agent-id",
  "conversation_id": "optional-for-continuing"
}
```

#### Alerting/Rules API (`/api/alerting/*`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/alerting/_health` | Get health status |
| GET | `/api/alerting/rule_types` | Get available rule types |
| GET | `/api/alerting/rules/_find` | Search/list rules |
| GET | `/api/alerting/rules/{id}` | Get rule by ID |
| POST | `/api/alerting/rules` | Create rule |
| PUT | `/api/alerting/rules/{id}` | Update rule |
| DELETE | `/api/alerting/rules/{id}` | Delete rule |
| POST | `/api/alerting/rules/{id}/_enable` | Enable rule |
| POST | `/api/alerting/rules/{id}/_disable` | Disable rule |

#### Connectors API (`/api/actions/*`)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/actions/connectors` | List all connectors |
| GET | `/api/actions/connector_types` | List connector types |

#### Other Working Endpoints
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/status` | Kibana status & plugin info |
| GET | `/api/streams` | List streams (empty) |
| GET | `/api/fleet/epm/packages` | List Fleet packages |

---

### Builtin Agent Builder Tools Found
- `platform.core.search` - Full-text & analytical search
- `platform.core.get_document_by_id` - Get doc by ID
- `platform.core.execute_esql` - Execute ES|QL query
- `platform.core.generate_esql` - NL to ES|QL
- `platform.core.get_index_mapping` - Get mappings
- `platform.core.list_indices` - List indices
- `platform.core.index_explorer` - NL index search
- `platform.core.create_visualization` - Create viz
- `platform.core.product_documentation` - Doc search
- `platform.core.cases` - Case management
- `platform.core.get_workflow_execution_status` - Check workflow status

---

### Workflows Management API Status

**Source:** [kibana/workflows_management/README.md](https://github.com/elastic/kibana/blob/824cb84ff6aebe38c320f9169cc6cad0b7fef445/src/platform/plugins/shared/workflows_management/README.md)

**âš ï¸ IMPORTANT: Workflows API requires SESSION AUTH, not API key auth!**

| API | API Key Auth (curl) | Session Auth (Dev Tools) |
|-----|---------------------|--------------------------|
| Agent Builder | âœ… Works | âœ… Works |
| Alerting | âœ… Works | âœ… Works |
| **Workflows** | âŒ Blocked | âœ… Works |

**Working Endpoints (via Dev Tools only):**
```
POST kbn://api/workflows/search
{"limit": 20, "page": 1, "query": ""}

POST kbn://api/workflows
{workflow definition}

GET kbn://api/workflows/{id}

DELETE kbn://api/workflows/{id}

POST kbn://api/workflows/{id}/execute
```

**To enable Workflows API (required first):**
```
POST kbn://internal/kibana/settings
{"changes": {"workflows:ui:enabled": true}}
```

**For Workshop Participants:**
- Use **Kibana UI** at `/app/workflows` for visual workflow management
- Use **Dev Tools** for API-style interactions with `kbn://` prefix
- API key auth via curl/scripts is NOT supported for Workflows

---

### Example Commands

**Test Cluster Connectivity:**
```bash
./admin/test_kibana_api.sh
```

**List Agent Builder Tools:**
```bash
source .env && curl -s -H "Authorization: ApiKey $ELASTICSEARCH_API_KEY" \
  -H "kbn-xsrf: true" \
  "$KIBANA_URL/api/agent_builder/tools" | jq '.results[] | .id'
```

**Create a Custom Tool:**
```bash
source .env && curl -s -X POST -H "Authorization: ApiKey $ELASTICSEARCH_API_KEY" \
  -H "kbn-xsrf: true" -H "Content-Type: application/json" \
  "$KIBANA_URL/api/agent_builder/tools" \
  -d '{"id": "workshop.tool", "type": "esql", "description": "...", "configuration": {"query": "...", "params": {}}}'
```

**Chat with Agent:**
```bash
source .env && curl -s -X POST -H "Authorization: ApiKey $ELASTICSEARCH_API_KEY" \
  -H "kbn-xsrf: true" -H "Content-Type: application/json" \
  "$KIBANA_URL/api/agent_builder/converse" \
  -d '{"input": "List all indices"}'
```

---

---

## SESSION CONTINUED (2026-01-21) - Challenge 4 Detection Query Debugging

### What Was Done This Session

1. **Fixed Target Business Setup** âœ…
   - Created `admin/setup_target_business.py` to create "The Golden Spoon" (target_biz_001)
   - Set review_count=5000 so it appears first in dropdown
   - Script is idempotent (checks if business exists before creating)

2. **Fixed ES|QL COUNT(CASE WHEN) Syntax** âœ…
   - ES|QL doesn't support `COUNT(CASE WHEN ...)` patterns
   - Changed to use `STATS ... BY status` or `AVG()` metrics

3. **Fixed Business Model Validation** âœ…
   - Added Pydantic field_validator to convert categories list to string
   - Fixed "Input should be a valid string" error in businesses API

4. **Fixed Bulk Attack Endpoint** âœ…
   - Root cause: bulk-attack created reviews with attacker user_ids but no matching user records
   - LOOKUP JOIN returned null for trust_score because users didn't exist
   - Added user creation in bulk-attack endpoint: creates both review AND user in same bulk operation
   - Attacker users have low trust scores (0.05-0.25) and new account ages (1-14 days)

5. **Verified Bulk Attack Works** âœ…
   - Tested endpoint directly with curl: `curl -X POST "http://localhost:8080/api/reviews/bulk-attack?business_id=target_biz_001&count=15"`
   - Returns success with 15 reviews created
   - Creates 15 attacker users with `is_attacker: true` and low trust scores (0.05-0.25)

6. **Verified Detection Query Works** âœ…
   - Tested ES|QL detection query with LOOKUP JOIN
   - Results: count=15, avg_trust=0.17, avg_stars=1.2
   - Detection correctly identifies low-trust attackers

### Current State

- **Web app running** at `http://localhost:8080` (port 8080, not 8000!)
- **Target business** "The Golden Spoon" (target_biz_001) exists
- **Bulk-attack endpoint** creates both reviews AND users now
- **Detection query** should work with fresh turbo attack

### Important: How to Run Turbo Attack

The UI has TWO attack modes:
1. **Submit Review** (left side) - Single review, uses `POST /api/reviews`
2. **Launch Turbo Attack** (right side) - Bulk attack, uses `POST /api/reviews/bulk-attack`

For detection to work, use the **Turbo Attack** button which creates 15+ reviews with matching attacker users.

### How to Test Detection Query

After running turbo attack, go to Kibana Discover (ES|QL mode) and run:

```esql
FROM reviews
| WHERE business_id == "target_biz_001"
| WHERE date > NOW() - 30 minutes
| WHERE stars <= 2
| LOOKUP JOIN users ON user_id
| WHERE trust_score IS NOT NULL
| WHERE trust_score < 0.3
| STATS
    count = COUNT(*),
    avg_trust = AVG(trust_score),
    avg_stars = AVG(stars)
```

This should show:
- count: Number of attack reviews with low trust users
- avg_trust: Low (0.05-0.25 range)
- avg_stars: Low (1-2 range)

---

### Current Cluster Configuration (2026-01-21)

**Cloud Hosted (9.3.0 GA):**
```
ES:     https://7d24f99aaf24471bb612b4021f10a320.us-west2.gcp.elastic-cloud.com:443
Kibana: https://gcp-la-9-3-latest-fea726.kb.us-west2.gcp.elastic-cloud.com
```

**Status:**
- âœ… ES Connection: v9.3.0 (traditional build)
- âœ… Kibana: v9.3.0
- âœ… Agent Builder API: Working (API key auth)
- âœ… Alerting API: Working (API key auth)
- âœ… Workflows API: Working via Dev Tools (session auth only)
- âš ï¸ Workflows API: NOT available via API key/curl
- ðŸ“ License: Trial (enterprise features enabled)

---

### Previous Session Work

1. **Challenge 02 (Workflows)** - Updated for Dev Tools approach:
   - Participants use Dev Tools commands instead of UI navigation
   - `POST kbn://api/workflows` with JSON body for creating workflows
   - `POST kbn://api/workflows/search` for listing/verifying workflows
   - Bonus workflows also provided as JSON for Dev Tools
   - Fixed YAMLâ†’JSON conversion with proper schema

2. **Challenge 03 (Agent Builder)** - Updated for actual UI + Dev Tools options:
   - ES|QL Parameters table format
   - Correct types: text, keyword, long, integer, double, float, boolean, date
   - Tool ID and Description fields
   - **Added Dev Tools API alternatives** for creating tools
   - Both UI and `POST kbn://api/agent_builder/tools` approaches documented
   - Bonus tools include Dev Tools commands

3. **Challenges use consistent approach:**
   - Challenge 01: ES|QL in Dev Tools (already good)
   - Challenge 02: Workflows via Dev Tools API
   - Challenge 03: Agent Builder UI with Dev Tools alternative
   - Challenge 04: ES|QL + curl commands (already good)

---

## HOW TO RESUME THIS SESSION

### Step 1: Start the Web Application

```bash
cd /workspace/elastic-workflow-workshop
source .env  # Load Elasticsearch credentials

# Check if app is already running
ps aux | grep uvicorn | grep -v grep

# If not running, start it:
python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8080 &

# Verify it's running
curl -s http://localhost:8080/health | jq
```

### Step 2: Verify Target Business Exists

```bash
# Check if The Golden Spoon exists
python3 admin/setup_target_business.py
```

### Step 3: Run a Fresh Turbo Attack

1. Open browser to `http://localhost:8080/attack`
2. Select "The Golden Spoon" from the dropdown
3. Click **"Launch Turbo Attack"** button (right side, red button)
4. Wait for success popup

### Step 4: Verify Detection Query

Go to Kibana Discover (ES|QL mode) and run:

```esql
FROM reviews
| WHERE business_id == "target_biz_001"
| WHERE date > NOW() - 30 minutes
| WHERE stars <= 2
| LOOKUP JOIN users ON user_id
| WHERE trust_score IS NOT NULL
| WHERE trust_score < 0.3
| STATS
    count = COUNT(*),
    avg_trust = AVG(trust_score),
    avg_stars = AVG(stars)
```

Expected: `count > 10`, `avg_trust < 0.3`, `avg_stars < 2`

**Verified Working (2026-01-21):**
```
count = 15, avg_trust = 0.17, avg_stars = 1.2
```

### Step 5: Continue With Challenge 4

The remaining tasks in Challenge 4 are:
- Task 3: Analyze attack with Agent Builder (use Review Fraud Investigator agent)
- Task 4: Implement workflow response (optional, requires workflow setup)

### Known Issues to Watch For

1. **Old attack data**: If detection shows null trust_scores, old attack reviews (from before the fix) don't have matching users. Run a fresh turbo attack.

2. **Webapp not restarted**: If changes aren't reflected, restart uvicorn:
   ```bash
   pkill -f uvicorn
   python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8080 &
   ```

3. **Wrong attack button**: The left "Submit Review" button creates single reviews WITHOUT matching users. Use "Launch Turbo Attack" on the right.

### Files Changed in This Session

| File | Change |
|------|--------|
| `app/routers/reviews.py` | bulk-attack now creates attacker users |
| `app/models/business.py` | categories field validator for listâ†’string |
| `admin/setup_target_business.py` | NEW - creates target business |
| `instruqt/challenges/04-end-to-end-scenario/assignment.md` | Fixed ES|QL queries |
| `.claude.md` | Updated with session notes and resume instructions |
| `docs/lessons-learned.md` | Added KEEP AS alias, COUNT(CASE WHEN), bulk user creation issues |

### Webapp Status

The webapp must be restarted after code changes to pick up the new bulk-attack endpoint:

```bash
# If webapp is running old code, restart it:
pkill -f uvicorn
python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8080 &
```

---

## SESSION COMPLETED (2026-01-21) - Workflow Automation & Full E2E Test

### What Was Done This Session

1. **Added Automated Response Actions to Workflow** âœ…
   - `protect_business()` - Sets `rating_protected: true` on attacked business
   - `hold_suspicious_reviews()` - Marks attack reviews as `status: "held"`
   - `execute_response_actions()` - Orchestrates all response actions
   - Response actions run for both new AND existing incidents

2. **Fixed Agent Builder Setup Script** âœ…
   - Removed `type` field from agent creation (auto-assigned by API)
   - Fixed tools format: `[{"tool_ids": [...]}]` not `["tool1", "tool2"]`
   - Script now works: `python admin/setup_agent_builder.py`

3. **Full End-to-End Test Verified** âœ…
   - Cleaned up previous test data
   - Set up target business (The Golden Spoon)
   - Launched 15-review attack
   - Detection workflow found attack and created incident
   - Response actions executed:
     - Business protected: âœ…
     - 15 reviews held: âœ…
     - Incident created (critical): âœ…
   - Agent Builder tools tested: all 3 working

### Files Changed

| File | Change |
|------|--------|
| `app/services/incident_service.py` | +96 lines - Response action methods |
| `app/routers/incidents.py` | +20 lines - Execute response actions on detect |
| `admin/setup_agent_builder.py` | Fixed agent creation format |
| `docs/lessons-learned.md` | Added response actions and API gotchas |
| `.claude.md` | This update |

### Verified End-to-End Flow

```
[Cleanup] â†’ [Attack] â†’ [Detection] â†’ [Response] â†’ [Investigation]
    â†“           â†“           â†“            â†“             â†“
Resolved    15 fake     Workflow    Business     Agent Builder
incidents   reviews     detects     protected    tools work
            + users     attack      + 15 held
```

### Test Results

| Component | Status | Details |
|-----------|--------|---------|
| Bulk Attack | âœ… | 15 reviews + attacker users created |
| Detection | âœ… | avg_trust=0.15, velocity=15/hr |
| Incident | âœ… | inc_c668d5d04e34, CRITICAL severity |
| Business Protected | âœ… | rating_protected=true |
| Reviews Held | âœ… | 15 reviews status=held |
| incident_summary | âœ… | Returns incident details |
| reviewer_analysis | âœ… | Shows CRITICAL/HIGH risk attackers |
| similar_reviews | âœ… | ELSER semantic search works |

### How to Run Full E2E Test

```bash
# 1. Clean up previous data
export $(grep -v '^#' .env | xargs)
curl -X POST "$ELASTICSEARCH_URL/incidents/_update_by_query" \
  -H "Authorization: ApiKey $ELASTICSEARCH_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"query": {"term": {"business_id": "target_biz_001"}}, "script": {"source": "ctx._source.status = \"resolved\""}}'

curl -X POST "$ELASTICSEARCH_URL/businesses/_update/target_biz_001" \
  -H "Authorization: ApiKey $ELASTICSEARCH_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"doc": {"rating_protected": false}}'

curl -X POST "$ELASTICSEARCH_URL/reviews/_delete_by_query" \
  -H "Authorization: ApiKey $ELASTICSEARCH_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"query": {"prefix": {"review_id": "attack_"}}}'

curl -X POST "$ELASTICSEARCH_URL/users/_delete_by_query" \
  -H "Authorization: ApiKey $ELASTICSEARCH_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"query": {"prefix": {"user_id": "attacker_"}}}'

# 2. Launch attack
curl -X POST "http://localhost:8080/api/reviews/bulk-attack?business_id=target_biz_001&count=15"

# 3. Run detection workflow (creates incident + executes response actions)
curl -X POST "http://localhost:8080/api/incidents/detect?business_id=target_biz_001&hours=1"

# 4. Verify results
curl "http://localhost:8080/api/businesses/target_biz_001" | jq '{rating_protected, protection_reason}'
curl "http://localhost:8080/api/incidents?business_id=target_biz_001" | jq '.incidents[0] | {incident_id, severity, response_actions}'
```
